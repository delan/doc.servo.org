<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The half-lock structure"><title>signal_hook_registry::half_lock - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="signal_hook_registry" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js" ><script src="../../static.files/storage-e2aeef58.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">Module half_lock</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../signal_hook_registry/index.html">signal_<wbr>hook_<wbr>registry</a><span class="version">1.4.8</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module half_<wbr>lock</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#atomic-orderings" title="Atomic orderings">Atomic orderings</a></li></ul><h3><a href="#structs">Module Items</a></h3><ul class="block"><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#constants" title="Constants">Constants</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate signal_<wbr>hook_<wbr>registry</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../index.html">signal_hook_registry</a></div><h1>Module <span>half_<wbr>lock</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/signal_hook_registry/half_lock.rs.html#1-232">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The half-lock structure</p>
<p>We need a way to protect the structure with configured hooks â€’ a signal may happen in arbitrary
thread and needs to read them while another thread might be manipulating the structure.</p>
<p>Under ordinary circumstances we would be happy to just use <code>Mutex&lt;HashMap&lt;c_int, _&gt;&gt;</code>. However,
as we use it in the signal handler, we are severely limited in what we can or canâ€™t use. So we
choose to implement kind of spin-look thing with atomics.</p>
<p>In the reader it is always simply locked and then unlocked, making sure it doesnâ€™t disappear
while in use.</p>
<p>The writer has a separate mutex (that prevents other writers; this is used outside of the
signal handler), makes a copy of the data and swaps an atomic pointer to the data structure.
But it waits until everything is unlocked (no signal handler has the old data) for dropping the
old instance. Thereâ€™s a generation trick to make sure that new signal locks another instance.</p>
<p>The downside is, this is an active spin lock at the writer end. However, we assume than:</p>
<ul>
<li>Signals are one time setup before we actually have threads. We just need to make <em>sure</em> we
are safe even if this is not true.</li>
<li>Signals are rare, happening at the same time as the write even rarer.</li>
<li>Signals are short, as there is mostly nothing allowed inside them anyway.</li>
<li>Our tool box is severely limited.</li>
</ul>
<p>Therefore this is hopefully reasonable trade-off.</p>
<h2 id="atomic-orderings"><a class="doc-anchor" href="#atomic-orderings">Â§</a>Atomic orderings</h2>
<p>The whole code uses SeqCst conservatively. Atomics are not used because of performance here and
are the minor price around signals anyway. But the comments state which orderings should be
enough in practice in case someone wants to get inspired (but do make your own check through
them anyway).</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">Â§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.HalfLock.html" title="struct signal_hook_registry::half_lock::HalfLock">Half<wbr>Lock</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="struct" href="struct.ReadGuard.html" title="struct signal_hook_registry::half_lock::ReadGuard">Read<wbr>Guard</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="struct" href="struct.WriteGuard.html" title="struct signal_hook_registry::half_lock::WriteGuard">Write<wbr>Guard</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt></dl><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">Â§</a></h2><dl class="item-table"><dt><a class="constant" href="constant.MAX_GUARDS.html" title="constant signal_hook_registry::half_lock::MAX_GUARDS">MAX_<wbr>GUARDS</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.YIELD_EVERY.html" title="constant signal_hook_registry::half_lock::YIELD_EVERY">YIELD_<wbr>EVERY</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt></dl></section></div></main></body></html>